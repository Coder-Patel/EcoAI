name: Convert to Static HTML and Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install stlite-desktop  # For converting Streamlit to static
    
    - name: Create static HTML version
      run: |
        mkdir -p static_build
        
        # Create a simple HTML wrapper for your Streamlit app
        cat > static_build/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>EcoWise Living Platform</title>
            <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.js"></script>
            <style>
                body {
                    margin: 0;
                    padding: 0;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                }
                #stlite-main {
                    height: 100vh;
                    width: 100vw;
                }
                .loading {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    font-size: 18px;
                }
            </style>
        </head>
        <body>
            <div id="stlite-main">
                <div class="loading">Loading EcoWise Living Platform...</div>
            </div>
            
            <script>
                const requirements = [
                    "streamlit",
                    "pandas",
                    "numpy",
                    "matplotlib",
                    "plotly",
                    "Pillow",
                    "requests",
                    "scikit-learn"
                ];
                
                stlite.mount(
                    {
                        requirements: requirements,
                        entrypoint: "main.py",
                        files: {
                            "main.py": `
        import streamlit as st
        
        st.set_page_config(
            page_title="EcoWise Living Platform",
            page_icon="üåç",
            layout="wide"
        )
        
        st.title("üåç EcoWise Living Platform")
        st.markdown("### Static Demo Version")
        
        st.info("This is a static demo version of the EcoWise Living Platform.")
        
        # Simple demo functionality
        st.subheader("Transportation Calculator")
        distance = st.slider("Daily commute distance (miles)", 0, 100, 20)
        transport_type = st.selectbox("Transportation type", ["Car", "Public Transit", "Bike", "Walk"])
        
        carbon_factors = {"Car": 0.404, "Public Transit": 0.089, "Bike": 0.0, "Walk": 0.0}
        daily_carbon = distance * carbon_factors.get(transport_type, 0)
        
        st.metric("Daily Carbon Footprint", f"{daily_carbon:.2f} kg CO2")
        
        st.subheader("Energy Usage")
        energy_usage = st.number_input("Monthly energy usage (kWh)", value=800)
        energy_cost = energy_usage * 0.12
        
        st.metric("Estimated Monthly Cost", f"${energy_cost:.2f}")
        
        st.subheader("Water Conservation")
        shower_time = st.slider("Average shower time (minutes)", 1, 20, 8)
        water_usage = shower_time * 2.5  # gallons per minute
        
        st.metric("Water per shower", f"{water_usage:.1f} gallons")
        
        st.markdown("---")
        st.markdown("**Note:** This is a simplified demo. The full application requires a Python server environment.")
        st.markdown("For the complete experience, visit the [full application](https://github.com/yourusername/yourrepository)")
                            `
                        }
                    },
                    document.getElementById("stlite-main")
                );
            </script>
        </body>
        </html>
        EOF
        
        # Copy any static assets
        if [ -d "assets" ]; then
            cp -r assets static_build/
        fi
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './static_build'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
